const t=new WeakMap,e="fluor$".length;export default async function n(t,e){const n=s(t||document.body),a=new WeakMap([...n].map((t=>[t,null])));for(const t of n)r(t,e);if(!t)return;async function r(t,e){const n=await o(t,e);a.set(t,n),n.render()}new MutationObserver((n=>{for(const o of n){const n="attributes"===o.type?[o.target]:o.addedNodes;for(const o of n){if(o.nodeType!==Node.ELEMENT_NODE)continue;const n=a.get(o);n&&!o.matches(t)&&(n.destroy(),a.delete(o)),!n&&o.matches(t)&&r(o,e)}}})).observe(document.body,{attributes:!0,childList:!0,subtree:!0})}async function o(o,d=null){const f=new AbortController,m={},p=new Map,b=JSON.parse(o?.dataset?.fluorData||"{}");function g(t){return t?.value}function y(t,e=[]){if(t instanceof Function){const n={value:t(...e.map(g)),update:t,dependencies:e};for(const t of e)p.set(t,[...p.get(t)??[],n]);return n}return{value:t,update:()=>t}}y.fromValue=t=>y((()=>r(t).value)),y.fromValueAsDate=t=>y((()=>r(t).valueAsDate)),y.fromValueAsNumber=t=>y((()=>r(t).valueAsNumber)),y.fromTextContent=(t,e=(t=>t))=>y((()=>e(r(t).textContent)));const w={Fluor:n,bindings:m,variable:y,get:g,set:(t,e=t.update)=>async()=>{t.value=await async function(t,e){return t instanceof Function?await t(e.value):t}(e,t);const n=p.get(t)??[];for(const t of n)t.value=t.update(...t?.dependencies.map(g)||[]);w.render()},bind(t){Object.assign(m,t)},toggle:t=>w.set(t,(t=>!t)),on(t,e,n,r={}){const s=i(n),c=t=>{const n=a(e)?e:t.target.closest(e);n&&o.contains(n)&&s(t)};o.addEventListener(t,c,r),f.signal.addEventListener("abort",(()=>{o.removeEventListener(t,c,r)}))},render:async function(){await async function(t,e){const n=[t];for(;n.length;){const t=n.shift();e(t,n),n.push(...t.childNodes)}}(o,((n,a)=>{const r=n.textContent;switch(n.nodeType){case Node.TEXT_NODE:{const e=t.get(n);if(e&&e!==o&&o.contains(e))break;if(e&&!e.contains(o)||t.set(n,o),r.match(/{{([^}]+)}}/g)){const t=r.split(/(?:{{|}})/g).reduce(((t,e,n)=>[...t,n%2==1&&new Comment("fluor$"+e),new Text(e)]),[]).filter(Boolean),e=document.createDocumentFragment();e.replaceChildren(...t),n.parentElement.replaceChild(e,n),a.push(...t)}break}case Node.COMMENT_NODE:{if(!r.startsWith("fluor$"))return;const t=r.slice(e);t in m&&(n.nextSibling.textContent=g(m[t]));break}case Node.ELEMENT_NODE:for(const t of Object.keys(n.dataset)){if(!t.startsWith("fluor")||"fluorData"===t)continue;const e=n.dataset[t];if(!(e in m)){const t=n.outerHTML,a=t.slice(0,t.indexOf(">")+1);o!==document.body&&console.warn(`Undefined or unbound variable ${e} in: ${a}`)}const a=g(m[e]);if(!a)break;switch(t){case"fluorText":n.textContent=a;break;case"fluorHtml":n.innerHTML=a;break;case"fluorLoop":{if("TEMPLATE"!==n.tagName){console.error("data-fluor-loop must be used on a template tag");continue}const t=a.map(((t,e)=>{const o=n.content.cloneNode(!0);return o.firstElementChild.dataset.fluorData=JSON.stringify({$loop:{item:t,index:e,count:a.length}}),o}));n.parentNode.replaceChildren(n,...t);break}default:{const e=t.replace(/fluor(-html)?/,"").toLowerCase();switch(a){case!0:n.setAttribute(e,"");break;case!1:n.removeAttribute(e);break;default:n.setAttribute(e,a)}break}}}}}))},destroy:function(){f.abort()},every:(t,e,n)=>function(t,e,n={leading:!1,signal:null}){const o=i(e),a=1e3*t;let r=Date.now()-(n.leading?a:0);const s=()=>{n?.signal?.aborted||(Date.now()-r>=a&&(r+=a,o()),requestAnimationFrame(s))};requestAnimationFrame(s)}(t,e,{...n,signal:f.signal}),delay:u,classNames:c,addClass:l("add",o),removeClass:l("remove",o),toggleClass:l("toggle",o),withEvent:t=>e=>i(t(e))(e),withTarget:t=>e=>i(t(e.target))(e),preventDefault:t=>t.preventDefault(),$data:b,$root:o,$loop:b.$loop||{},$:(t,e=o)=>r(t,e),$$:(t,e=o)=>s(t,e)};return w.bind(Object.fromEntries(Object.entries(w.$loop).map((([t,e])=>[`$loop.${t}`,y(e)])))),d&&await d(w),w}function a(t){return t instanceof Node}function r(t,e=document){return a(t)?t:e.querySelector(t)}function s(t,e=document){return a(t)?[t]:e.querySelectorAll(t)}function c(...t){return t.flatMap((t=>Array.isArray(t)?t.map((t=>c(t))):"string"==typeof t?t:c(Object.keys(t).filter((e=>t[e]))))).join(" ")}function i(t){return Array.isArray(t)?async function(...e){for(const n of t)await n(...e)}:t}function u(t,e){return()=>{const n=i(e),o=1e3*t;let a=Date.now();const r=()=>{Date.now()-a<o?requestAnimationFrame(r):n()};requestAnimationFrame(r)}}function l(t,e){return(n,o)=>a=>{const r=o?s(o,e):[a.target];for(const e of r)e.classList[t](n)}}new URL(import.meta.url).searchParams.has("init")&&(async()=>{const t=Object.keys(await o());await new Promise((t=>{"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()})),window.Fluor=n;const e=s("script[type=fluor]");for(const n of e){const e=n.dataset.fluorSelector,o=document.createElement("script");if(n.hasAttribute("src"))try{const t=n.getAttribute("src"),e=await fetch(t);if(e.status>=400)throw new Error(`Unable to load Fluor script at ${t}`);const o=await e.text();n.textContent=o}catch(t){n.textContent=`console.error(${JSON.stringify(t.message)})`}o.textContent=`Fluor(${JSON.stringify(e)}, async ({${t.join(",")}}) => {${n.textContent}})`,n.parentNode.removeChild(n),document.body.appendChild(o)}})();